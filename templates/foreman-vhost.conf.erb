<%= ERB.new(File.read(File.expand_path("_header.erb",File.dirname(file)))).result(binding) -%>

<VirtualHost <%= ipaddress %>:80>
  ServerName <%= fqdn %>
  ServerAlias foreman
  DocumentRoot <%= scope.lookupvar 'foreman::app_root' %>/public
  PassengerAppRoot <%= scope.lookupvar 'foreman::app_root' %>

  RailsAutoDetect On
  AddDefaultCharset UTF-8

</VirtualHost>

<VirtualHost <%= ipaddress %>:443>
  ServerName <%= fqdn %>
  ServerAlias foreman

  RailsAutoDetect On
  DocumentRoot <%= scope.lookupvar 'foreman::app_root' %>/public
  PassengerAppRoot <%= scope.lookupvar 'foreman::app_root' %>

  # Use puppet certificates for SSL

  SSLEngine On
  SSLCertificateFile      <%= scope.lookupvar("::puppet::server::ssl_cert") %>
  SSLCertificateKeyFile   <%= scope.lookupvar("::puppet::server::ssl_cert_key") %>
  SSLCertificateChainFile <%= scope.lookupvar("::puppet::server::ssl_chain") %>
  SSLCACertificateFile    <%= scope.lookupvar("::puppet::server::ssl_ca_cert") %>
  SSLVerifyClient         optional
  SSLOptions              +StdEnvVars
  SSLVerifyDepth          3

</VirtualHost>
